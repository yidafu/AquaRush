spring:
  application:
    name: aqua-rush
  web:
    resources:
      add-mappings: true
  mvc:
    throw-exception-if-no-handler-found: true

  datasource:
    url: jdbc:postgresql://localhost:5432/aqua_rush?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:admin123}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 60000
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
      validation-timeout: 5000
      leak-detection-threshold: 60000

  jpa:
    hibernate:
      ddl-auto: none  # 设置为 none，不进行任何自动 DDL 操作
    show-sql: true
    generate-ddl: false        # 禁用 JPA 自动 DDL
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true

  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    default-schema: public
    drop-first: false         # 生产环境必须为 false！
    enabled: true             # Re-enable Liquibase after fixing configuration

  artemis:
    mode: embedded
    embedded:
      enabled: true
      persistent: true
      data-directory: ./data/artemis
      queues:
        - order-events
        - payment-events
        - delivery-events
        - user-events
      topics:
        - broadcast-events

  jms:
    template:
      default-destination: order-events
      delivery-mode: persistent
      priority: 100
      time-to-live: 3600000 # 1小时

  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    serialization:
      FAIL_ON_EMPTY_BEANS: false
      INDENT_OUTPUT: true
    deserialization:
      FAIL_ON_UNKNOWN_PROPERTIES: false
      FAIL_ON_NULL_FOR_PRIMITIVES: false
    default-property-inclusion: NON_NULL

  # GraphQL configuration
  graphql:
    schema:
      printer:
        enabled: true
      file-extensions: .graphqls
    graphiql:
      enabled: true
      path: /graphiql
    schema-introspection: on
    path: /graphql

server:
  port: 8080
  servlet:
    context-path:
main:
  allow-bean-definition-overriding: true
  compression:
    enabled: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

logging:
  level:
    liquibase: DEBUG
    org.springframework.boot.autoconfigure.liquibase: DEBUG
    root: INFO
    dev.yidafu.aqua: DEBUG
    # Enhanced logging for request troubleshooting
    dev.yidafu.aqua.security: DEBUG
    dev.yidafu.aqua.exception: DEBUG
    dev.yidafu.aqua.error: DEBUG
    dev.yidafu.aqua.audit: INFO
    dev.yidafu.aqua.security.request: DEBUG
    dev.yidafu.aqua.security.jwt: DEBUG
    dev.yidafu.aqua.interceptor.test: DEBUG
    # Spring Security logging
    org.springframework.security: DEBUG
    org.springframework.web: DEBUG
    # Filter chain logging
    org.springframework.boot.web.servlet: DEBUG
    # Database access logging
    org.springframework.jdbc: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  security:
    user:
      name: admin
      password: 123456
# Application specific properties
aqua:
  id:
    snowflake:
      machine-id: ${SNOWFLAKE_MACHINE_ID:1}
  wechat:
    app-id: ${WECHAT_APP_ID:your-app-id}
    app-secret: ${WECHAT_APP_SECRET:your-app-secret}
  messaging:
    enabled: true
    strategy: artemis # artemis, hybrid, outbox-only, memory-only
    # 轻量级内存队列配置
    memory-queue:
      enabled: true
      max-size: 5000      # 减少内存占用
      batch-size: 50        # 批处理大小
      poll-interval-ms: 50   # 50ms轮询间隔，低延迟
      high-frequency-events: ["ORDER_PAID", "PAYMENT_TIMEOUT", "DELIVERY_TIMEOUT"] # 高频事件
      low-frequency-events: ["ORDER_CREATED", "ORDER_CANCELLED", "ORDER_DELIVERED"] # 低频事件
    # 传统Outbox配置（作为备份）
    outbox:
      enabled: true
      poll-interval-seconds: 60  # 60秒轮询
      max-retry-count: 5
      retry-delays-ms: [60000, 300000, 900000, 3600000, 21600000] # 1min, 5min, 15min, 1hr, 6hr
      cleanup-days: 30
    # ActiveMQ Artemis配置
    artemis:
      # 连接池配置
      pool:
        enabled: true
        max-connections: 10
        max-sessions-per-connection: 50
      # 重试配置
      retry:
        max-attempts: 3
        initial-interval: 1000 # 1秒
        multiplier: 2.0
        max-interval: 30000 # 30秒

# Legacy WeChat configuration for backward compatibility
wechat:
  appid: ${WECHAT_APP_ID:your-app-id}
  secret: ${WECHAT_APP_SECRET:your-app-secret}
  api-url: ${WECHAT_API_URL:https://api.weixin.qq.com}
  token-cache-minutes: 90
  max-retries: 3
  retry-delay-minutes: 5
  templates:
    order_created: ${WECHAT_TEMPLATE_ORDER_CREATED:your-order-created-template}
    order_paid: ${WECHAT_TEMPLATE_ORDER_PAID:your-order-paid-template}
    order_cancelled: ${WECHAT_TEMPLATE_ORDER_CANCELLED:your-order-cancelled-template}
    order_delivered: ${WECHAT_TEMPLATE_ORDER_DELIVERED:your-order-delivered-template}
    payment_failed: ${WECHAT_TEMPLATE_PAYMENT_FAILED:your-payment-failed-template}
    delivery_assigned: ${WECHAT_TEMPLATE_DELIVERY_ASSIGNED:your-delivery-assigned-template}
    delivery_started: ${WECHAT_TEMPLATE_DELIVERY_STARTED:your-delivery-started-template}
    delivery_delayed: ${WECHAT_TEMPLATE_DELIVERY_DELAYED:your-delivery-delayed-template}
    promotional: ${WECHAT_TEMPLATE_PROMOTIONAL:your-promotional-template}

# WeChat Pay configuration
wechat-pay:
  mch-id: ${WECHAT_PAY_MCH_ID:your-mch-id}
  api-v3-key: ${WECHAT_PAY_API_V3_KEY:your-api-v3-key}
  merchant-serial-number: ${WECHAT_PAY_SERIAL_NUMBER:your-serial-number}
  private-key-path: ${WECHAT_PAY_PRIVATE_KEY_PATH:classpath:certs/apiclient_key.pem}


# JWT configuration
app:
  jwt:
    secret: ${JWT_SECRET:your-jwt-secret-key-change-in-production}
    expiration: 86400 # 24 hours in seconds
    refresh-expiration: 604800 # 7 days in seconds
