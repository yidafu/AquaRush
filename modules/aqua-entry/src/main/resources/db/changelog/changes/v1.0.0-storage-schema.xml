<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.33.xsd">

    <changeSet id="1.0.0-create-storage-schema" author="aqua-rush">
        <comment>Create file metadata table for storage system</comment>
        <createTable tableName="file_metadata">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="file_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="storage_path" type="varchar(500)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="file_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="file_size" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="mime_type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="checksum" type="varchar(64)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="is_public" type="boolean" defaultValueNumeric="true">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1000)"/>
            <column name="extension" type="varchar(10)"/>
            <column name="owner_id" type="bigint"/>
        </createTable>

        <createIndex tableName="file_metadata" indexName="idx_file_metadata_checksum">
            <column name="checksum"/>
        </createIndex>

        <createIndex tableName="file_metadata" indexName="idx_file_metadata_storage_path">
            <column name="storage_path"/>
        </createIndex>

        <createIndex tableName="file_metadata" indexName="idx_file_metadata_file_type">
            <column name="file_type"/>
        </createIndex>

        <createIndex tableName="file_metadata" indexName="idx_file_metadata_owner_id">
            <column name="owner_id"/>
        </createIndex>

        <createIndex tableName="file_metadata" indexName="idx_file_metadata_created_at">
            <column name="created_at"/>
        </createIndex>

        <createIndex tableName="file_metadata" indexName="idx_file_metadata_is_public">
            <column name="is_public"/>
        </createIndex>

        <sql>
            ALTER TABLE file_metadata ADD CONSTRAINT chk_file_type
            CHECK (file_type IN ('IMAGE', 'VIDEO', 'AUDIO', 'DOCUMENT', 'SPREADSHEET', 'PRESENTATION', 'FRONTEND', 'ARCHIVE', 'EXECUTABLE', 'BACKUP', 'OTHER'));
        </sql>

        <sql>
            ALTER TABLE file_metadata ADD CONSTRAINT chk_file_size_positive
            CHECK (file_size > 0);
        </sql>

        <sql>
            CREATE OR REPLACE FUNCTION update_file_metadata_updated_at()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
            END
            $$ LANGUAGE plpgsql;

            CREATE TRIGGER trigger_file_metadata_updated_at
            BEFORE UPDATE ON file_metadata
            FOR EACH ROW
            EXECUTE FUNCTION update_file_metadata_updated_at();
        </sql>
    </changeSet>

</databaseChangeLog>