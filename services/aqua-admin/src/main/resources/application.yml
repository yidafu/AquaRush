spring:
  application:
    name: aqua-delivery-admin-service
  web:
    resources:
      add-mappings: true
  mvc:
    throw-exception-if-no-handler-found: true

  datasource:
    url: jdbc:postgresql://localhost:5432/aqua_rush?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:admin123}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 30
      minimum-idle: 10
      connection-timeout: 60000
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
      validation-timeout: 5000
      leak-detection-threshold: 60000
      pool-name: DeliveryAdminServicePool

  jpa:
    hibernate:
      ddl-auto: none  # 不进行任何自动 DDL 操作
    show-sql: true
    generate-ddl: false        # 禁用 JPA 自动 DDL
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true

  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    default-schema: public
    drop-first: false         # 生产环境必须为 false！
    enabled: false            # Disable Liquibase for admin service since main app manages schema

  artemis:
    mode: embedded
    embedded:
      enabled: true
      persistent: true
      data-directory: ./data/artemis-delivery
      queues:
        - order-events
        - payment-events
        - delivery-events
        - user-events
      topics:
        - broadcast-events

  jms:
    template:
      default-destination: delivery-events
      delivery-mode: persistent
      priority: 100
      time-to-live: 3600000 # 1小时

  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    serialization:
      FAIL_ON_EMPTY_BEANS: false
      INDENT_OUTPUT: true
    deserialization:
      FAIL_ON_UNKNOWN_PROPERTIES: false
      FAIL_ON_NULL_FOR_PRIMITIVES: false
    default-property-inclusion: NON_NULL

  # GraphQL configuration
  graphql:
    schema:
      printer:
        enabled: true
      file-extensions: .graphqls
      locations: classpath:graphql/, classpath:shared-config/graphql/
    graphiql:
      enabled: true
      path: /graphiql
    schema-introspection: on
    path: /graphql

server:
  port: 9090
  servlet:
    context-path:
main:
  allow-bean-definition-overriding: true
  compression:
    enabled: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

logging:
  level:
    liquibase: DEBUG
    org.springframework.boot.autoconfigure.liquibase: DEBUG
    root: INFO
    dev.yidafu.aqua: DEBUG
    # Enhanced logging for request troubleshooting
    dev.yidafu.aqua.security: DEBUG
    dev.yidafu.aqua.exception: DEBUG
    dev.yidafu.aqua.error: DEBUG
    dev.yidafu.aqua.audit: INFO
    dev.yidafu.aqua.security.request: DEBUG
    dev.yidafu.aqua.security.jwt: DEBUG
    dev.yidafu.aqua.interceptor.test: DEBUG
    # Spring Security logging
    org.springframework.security: DEBUG
    org.springframework.web: DEBUG
    # Database access logging
    org.springframework.jdbc: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  security:
    user:
      name: admin
      password: 123456

# Application specific properties
aqua:
  id:
    snowflake:
      machine-id: ${SNOWFLAKE_MACHINE_ID:2} # Different machine ID for delivery service
  wechat:
    app-id: ${WECHAT_APP_ID:your-app-id}
    app-secret: ${WECHAT_APP_SECRET:your-app-secret}
  messaging:
    enabled: true
    strategy: artemis # artemis, hybrid, outbox-only, memory-only
    # 轻量级内存队列配置
    memory-queue:
      enabled: true
      max-size: 8000      # 配送服务需要处理更多事件
      batch-size: 100       # 批处理大小
      poll-interval-ms: 25   # 25ms轮询间隔，更快的响应
      high-frequency-events: ["ORDER_PAID", "DELIVERY_ASSIGNED", "DELIVERY_TIMEOUT", "DELIVERY_STARTED"]
      low-frequency-events: ["ORDER_CREATED", "ORDER_DELIVERED", "DELIVERY_COMPLETED"]
    # 传统Outbox配置（作为备份）
    outbox:
      enabled: true
      poll-interval-seconds: 15  # 15秒轮询，最快的响应
      max-retry-count: 5
      retry-delays-ms: [15000, 30000, 60000, 300000, 900000] # 15s, 30s, 1min, 5min, 15min
      cleanup-days: 30
  mode: admin

# Storage configuration
storage:
  type: local
  local:
    base-path: ${STORAGE_BASE_PATH:./data/storage}
    max-file-size: 104857600  # 100MB
    allowed-extensions: ["jpg", "jpeg", "png", "gif", "bmp", "webp", "mp4", "avi", "mov", "wmv", "flv", "mp3", "wav", "flac", "aac", "pdf", "doc", "docx", "txt", "xls", "xlsx", "csv", "ppt", "pptx", "html", "css", "js", "zip", "rar", "7z", "tar", "gz", "exe", "msi", "sh", "bat", "bak", "backup"]

# JWT configuration
app:
  jwt:
    secret: ${JWT_SECRET:your-jwt-secret-key-change-in-production}
    expiration: 86400 # 24 hours in seconds
    refresh-expiration: 604800 # 7 days in seconds
